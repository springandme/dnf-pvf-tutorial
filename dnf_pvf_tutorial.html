<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DNF PVF æ•™ç¨‹</title>
    <link rel="stylesheet" href="style.css">

    <!-- é¢„åŠ è½½è®¾ç½®ï¼Œé¿å…é¡µé¢é—ªçƒ -->
    <script>
        // åœ¨é¡µé¢æ¸²æŸ“å‰åº”ç”¨ä¿å­˜çš„è®¾ç½®
        (function() {
            // åº”ç”¨ä¸»é¢˜è®¾ç½®
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                document.documentElement.classList.add('dark-theme');
            }

            // åº”ç”¨å­—ä½“å¤§å°è®¾ç½®
            const savedFontSize = localStorage.getItem('fontSize');
            if (savedFontSize) {
                document.documentElement.style.fontSize = savedFontSize + 'px';
            }

            // æ·»åŠ é¡µé¢å‡†å¤‡çŠ¶æ€ç±»ï¼Œé¿å…å†…å®¹é—ªçƒ
            document.documentElement.classList.add('page-loading');
        })();
    </script>
</head>
<body>
    <div id="app">
      <div id="sidebar">
        <div class="sidebar-header">
          <h2>è¯¾ç¨‹ç›®å½•</h2>
          <div class="search-container">
            <div class="search-box">
              <input type="text" id="search-input" placeholder="æœç´¢æ•™ç¨‹... (Ctrl+F)" autocomplete="off">
              <button id="search-clear" class="search-clear" title="æ¸…é™¤æœç´¢">Ã—</button>
            </div>
            <div id="search-stats" class="search-stats"></div>
          </div>
        </div>
        <div id="file-tree-container">
          <div id="file-tree"></div>
          <div id="search-results" class="search-results" style="display: none;"></div>
        </div>
        <div id="loading-indicator" class="loading-indicator" style="display: none;">
          <div class="spinner"></div>
          <span>åŠ è½½ä¸­...</span>
        </div>
      </div>
      <div id="content-container">
        <div class="content-header">
          <div class="breadcrumb" id="breadcrumb"></div>
          <div class="content-actions">
            <button id="toggle-theme" class="action-btn" title="åˆ‡æ¢ä¸»é¢˜">ğŸŒ™</button>
            <button id="font-size-decrease" class="action-btn" title="å‡å°å­—ä½“">A-</button>
            <button id="font-size-increase" class="action-btn" title="å¢å¤§å­—ä½“">A+</button>
          </div>
        </div>
        <div id="content-body">
          <div class="welcome-message">
            <h1>ğŸ® DNF PVF æ•™ç¨‹é˜…è¯»å™¨</h1>
            <p>è¯·åœ¨å·¦ä¾§é€‰æ‹©ä¸€ä¸ªæ•™ç¨‹æ–‡ä»¶å¼€å§‹å­¦ä¹ ï¼Œæˆ–ä½¿ç”¨æœç´¢åŠŸèƒ½å¿«é€ŸæŸ¥æ‰¾å†…å®¹ã€‚</p>
            <div class="quick-tips">
              <h3>ğŸ’¡ ä½¿ç”¨æŠ€å·§ï¼š</h3>
              <ul>
                <li><kbd>Ctrl</kbd> + <kbd>F</kbd> - æ‰“å¼€æœç´¢</li>
                <li><kbd>â†‘</kbd> <kbd>â†“</kbd> - å¯¼èˆªæœç´¢ç»“æœ</li>
                <li><kbd>Enter</kbd> - æ‰“å¼€é€‰ä¸­æ–‡ä»¶</li>
                <li><kbd>Esc</kbd> - æ¸…é™¤æœç´¢</li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // DOM å…ƒç´ å¼•ç”¨
            const fileTreeContainer = document.getElementById('file-tree');
            const contentContainer = document.getElementById('content-body');
            const searchInput = document.getElementById('search-input');
            const searchClear = document.getElementById('search-clear');
            const searchResults = document.getElementById('search-results');
            const searchStats = document.getElementById('search-stats');
            const loadingIndicator = document.getElementById('loading-indicator');
            const breadcrumb = document.getElementById('breadcrumb');

            // åº”ç”¨çŠ¶æ€
            let allFiles = [];
            let filteredFiles = [];
            let currentSearchTerm = '';
            let selectedIndex = -1;
            let isSearchMode = false;

            // åˆå§‹åŒ–å±•å¼€æ–‡ä»¶å¤¹çŠ¶æ€ - é»˜è®¤æ‰€æœ‰æ–‡ä»¶å¤¹éƒ½æ˜¯æŠ˜å çš„
            // é€šè¿‡ CSS ç¡®ä¿é»˜è®¤æŠ˜å ï¼ŒJavaScript åªç®¡ç†ç”¨æˆ·çš„å±•å¼€åå¥½
            let expandedFolders = new Set();

            // å°è¯•ä» localStorage è¯»å–ç”¨æˆ·çš„å±•å¼€åå¥½ï¼ˆå¦‚æœå¯ç”¨ï¼‰
            // åœ¨éšç§æ¨¡å¼ä¸‹ï¼ŒlocalStorage å¯èƒ½ä¸å¯ç”¨ï¼Œè¿™æ—¶ä¿æŒé»˜è®¤æŠ˜å çŠ¶æ€
            try {
                const savedExpanded = localStorage.getItem('expandedFolders');
                if (savedExpanded) {
                    expandedFolders = new Set(JSON.parse(savedExpanded));
                }
            } catch (e) {
                // éšç§æ¨¡å¼æˆ–å…¶ä»–æƒ…å†µä¸‹ localStorage ä¸å¯ç”¨ï¼Œä¿æŒé»˜è®¤ç©ºçŠ¶æ€
                console.log('localStorage ä¸å¯ç”¨ï¼Œä½¿ç”¨é»˜è®¤æŠ˜å çŠ¶æ€');
                expandedFolders = new Set();
            }
            const recentFiles = JSON.parse(localStorage.getItem('recentFiles')) || [];

            // å·¥å…·å‡½æ•°
            function saveExpandedState() {
                try {
                    localStorage.setItem('expandedFolders', JSON.stringify(Array.from(expandedFolders)));
                } catch (e) {
                    // éšç§æ¨¡å¼ä¸‹ localStorage å¯èƒ½ä¸å¯ç”¨ï¼Œé™é»˜å¿½ç•¥
                    console.log('æ— æ³•ä¿å­˜å±•å¼€çŠ¶æ€ï¼ˆå¯èƒ½æ˜¯éšç§æ¨¡å¼ï¼‰');
                }
            }

            function saveRecentFiles() {
                localStorage.setItem('recentFiles', JSON.stringify(recentFiles.slice(0, 10)));
            }

            function addToRecentFiles(filePath) {
                const index = recentFiles.indexOf(filePath);
                if (index > -1) {
                    recentFiles.splice(index, 1);
                }
                recentFiles.unshift(filePath);
                saveRecentFiles();
            }

            function showLoading() {
                loadingIndicator.style.display = 'flex';
            }

            function hideLoading() {
                loadingIndicator.style.display = 'none';
            }

            function updateBreadcrumb(filePath) {
                if (!filePath) {
                    breadcrumb.innerHTML = '';
                    return;
                }

                const parts = filePath.split(/[\/\\]/).filter(part => part);
                const breadcrumbHtml = parts.map((part, index) => {
                    const isLast = index === parts.length - 1;
                    const displayName = part.replace(/\.json$/, '');
                    const partialPath = parts.slice(0, index + 1).join('/');

                    if (isLast) {
                        return `<span class="breadcrumb-current">${displayName}</span>`;
                    } else {
                        return `<span class="breadcrumb-item" data-path="${partialPath}" title="ç‚¹å‡»è·³è½¬åˆ° ${displayName}">${displayName}</span>`;
                    }
                }).join('<span class="breadcrumb-separator">></span>');

                breadcrumb.innerHTML = breadcrumbHtml;

                // ç»‘å®šé¢åŒ…å±‘ç‚¹å‡»äº‹ä»¶
                breadcrumb.querySelectorAll('.breadcrumb-item[data-path]').forEach(item => {
                    item.addEventListener('click', () => {
                        const targetPath = item.dataset.path;
                        navigateToDirectory(targetPath);
                    });
                });
            }

            // é¢åŒ…å±‘å¯¼èˆªåŠŸèƒ½
            function navigateToDirectory(targetPath) {
                console.log('å¯¼èˆªåˆ°ç›®å½•:', targetPath);

                // æ¸…é™¤æœç´¢çŠ¶æ€
                if (isSearchMode) {
                    clearSearch();
                }

                // å±•å¼€åˆ°ç›®æ ‡è·¯å¾„çš„æ‰€æœ‰çˆ¶ç›®å½•
                expandPathToDirectory(targetPath);

                // é«˜äº®æ˜¾ç¤ºç›®æ ‡ç›®å½•
                highlightDirectoryInTree(targetPath);

                // æ»šåŠ¨åˆ°ç›®æ ‡ç›®å½•
                scrollToDirectoryInTree(targetPath);
            }

            function expandPathToDirectory(targetPath) {
                const pathParts = targetPath.split('/');
                let currentPath = '';

                // é€çº§å±•å¼€è·¯å¾„
                pathParts.forEach(part => {
                    currentPath += (currentPath ? '/' : '') + part;
                    expandedFolders.add(currentPath);
                });

                saveExpandedState();

                // é‡æ–°æ¸²æŸ“æ–‡ä»¶æ ‘ä»¥æ˜¾ç¤ºå±•å¼€çŠ¶æ€
                if (allFiles.length > 0) {
                    const fileTree = buildTree(allFiles);
                    renderTree(fileTree, fileTreeContainer);
                }
            }

            function highlightDirectoryInTree(targetPath) {
                // ç§»é™¤ä¹‹å‰çš„é«˜äº®
                document.querySelectorAll('#file-tree .folder-content.highlighted').forEach(el => {
                    el.classList.remove('highlighted');
                });

                // æŸ¥æ‰¾å¹¶é«˜äº®ç›®æ ‡ç›®å½•
                const folderElements = document.querySelectorAll('#file-tree .folder-content');
                folderElements.forEach(element => {
                    const folderLi = element.closest('li');
                    if (folderLi) {
                        const folderPath = getFolderPathFromElement(folderLi);
                        if (folderPath === targetPath) {
                            element.classList.add('highlighted');
                            // æ·»åŠ ä¸´æ—¶é«˜äº®æ•ˆæœ
                            setTimeout(() => {
                                element.classList.remove('highlighted');
                            }, 3000);
                        }
                    }
                });
            }

            function scrollToDirectoryInTree(targetPath) {
                const folderElements = document.querySelectorAll('#file-tree .folder-content');
                folderElements.forEach(element => {
                    const folderLi = element.closest('li');
                    if (folderLi) {
                        const folderPath = getFolderPathFromElement(folderLi);
                        if (folderPath === targetPath) {
                            element.scrollIntoView({
                                behavior: 'smooth',
                                block: 'center'
                            });
                        }
                    }
                });
            }

            function getFolderPathFromElement(folderElement) {
                // ä½¿ç”¨ data-folder-path å±æ€§ç›´æ¥è·å–è·¯å¾„
                return folderElement.dataset.folderPath || '';
            }

            // æœç´¢åŠŸèƒ½
            function normalizeText(text) {
                return text.toLowerCase().replace(/[^\w\s\u4e00-\u9fff]/g, '');
            }

            function highlightText(text, searchTerm) {
                if (!searchTerm) return text;
                const regex = new RegExp(`(${searchTerm.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
                return text.replace(regex, '<mark>$1</mark>');
            }

            function searchFiles(searchTerm) {
                if (!searchTerm.trim()) {
                    return allFiles;
                }

                const normalizedTerm = normalizeText(searchTerm);
                return allFiles.filter(file => {
                    const fileName = normalizeText(file.name || file.path);
                    const filePath = normalizeText(file.path);
                    return fileName.includes(normalizedTerm) || filePath.includes(normalizedTerm);
                }).sort((a, b) => {
                    // ä¼˜å…ˆæ˜¾ç¤ºæ–‡ä»¶ååŒ¹é…çš„ç»“æœ
                    const aNameMatch = normalizeText(a.name || a.path).includes(normalizedTerm);
                    const bNameMatch = normalizeText(b.name || b.path).includes(normalizedTerm);
                    if (aNameMatch && !bNameMatch) return -1;
                    if (!aNameMatch && bNameMatch) return 1;
                    return (a.name || a.path).localeCompare(b.name || b.path, 'zh-CN');
                });
            }

            function renderSearchResults(results, searchTerm) {
                if (!results.length) {
                    searchResults.innerHTML = '<div class="no-results">æœªæ‰¾åˆ°åŒ¹é…çš„æ•™ç¨‹</div>';
                    return;
                }

                const html = results.map((file, index) => {
                    const fileName = (file.name || file.path).replace(/\.json$/, '');
                    const filePath = file.path;
                    const highlightedName = highlightText(fileName, searchTerm);
                    const highlightedPath = highlightText(filePath, searchTerm);

                    return `
                        <div class="search-result-item ${index === selectedIndex ? 'selected' : ''}"
                             data-index="${index}" data-path="${filePath}">
                            <div class="result-name">${highlightedName}</div>
                            <div class="result-path">${highlightedPath}</div>
                        </div>
                    `;
                }).join('');

                searchResults.innerHTML = html;

                // ç»‘å®šç‚¹å‡»äº‹ä»¶
                searchResults.querySelectorAll('.search-result-item').forEach(item => {
                    item.addEventListener('click', () => {
                        const filePath = item.dataset.path;
                        loadFileContent(filePath);
                        clearSearch();
                    });
                });
            }

            function updateSearchStats(results, searchTerm) {
                if (!searchTerm.trim()) {
                    searchStats.textContent = '';
                    return;
                }
                searchStats.textContent = `æ‰¾åˆ° ${results.length} ä¸ªç»“æœ`;
            }

            function performSearch() {
                const searchTerm = searchInput.value.trim();
                currentSearchTerm = searchTerm;

                if (!searchTerm) {
                    isSearchMode = false;
                    searchResults.style.display = 'none';
                    fileTreeContainer.style.display = 'block';
                    updateSearchStats([], '');
                    return;
                }

                isSearchMode = true;
                filteredFiles = searchFiles(searchTerm);
                selectedIndex = filteredFiles.length > 0 ? 0 : -1;

                searchResults.style.display = 'block';
                fileTreeContainer.style.display = 'none';

                renderSearchResults(filteredFiles, searchTerm);
                updateSearchStats(filteredFiles, searchTerm);
            }

            function clearSearch() {
                searchInput.value = '';
                currentSearchTerm = '';
                selectedIndex = -1;
                isSearchMode = false;
                searchResults.style.display = 'none';
                fileTreeContainer.style.display = 'block';
                updateSearchStats([], '');
                searchInput.blur();
            }

            // 1. è·å–æ–‡ä»¶åˆ—è¡¨å¹¶æ„å»ºæ–‡ä»¶æ ‘ï¼ˆå¸¦ç¼“å­˜ï¼‰
            function getFiles() {
                showLoading();

                const cachedFiles = localStorage.getItem('fileList');
                if (cachedFiles) {
                    try {
                        console.log('ä»ç¼“å­˜åŠ è½½æ–‡ä»¶åˆ—è¡¨ã€‚');
                        const files = JSON.parse(cachedFiles);
                        allFiles = files;
                        const fileTree = buildTree(files);
                        renderTree(fileTree, fileTreeContainer);
                        hideLoading();
                        return;
                    } catch (e) {
                        console.error('è§£æç¼“å­˜å¤±è´¥ï¼Œé‡æ–°è·å–', e);
                        localStorage.removeItem('fileList');
                    }
                }

                // æ£€æµ‹è¿è¡Œç¯å¢ƒï¼šGitHub Pages ä½¿ç”¨é™æ€æ–‡ä»¶ï¼Œæœ¬åœ°å¼€å‘ä½¿ç”¨åŠ¨æ€ API
                const isGitHubPages = window.location.hostname.includes('github.io');
                const apiUrl = isGitHubPages ? './api/files.json' : '/api/files';

                console.log(`ä» ${isGitHubPages ? 'é™æ€æ–‡ä»¶' : 'API'} è·å–æ–‡ä»¶åˆ—è¡¨: ${apiUrl}`);

                fetch(apiUrl)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                        }
                        return response.json();
                    })
                    .then(files => {
                        if (Array.isArray(files)) {
                            localStorage.setItem('fileList', JSON.stringify(files));
                            allFiles = files;
                            const fileTree = buildTree(files);
                            renderTree(fileTree, fileTreeContainer);
                            console.log(`æˆåŠŸåŠ è½½ ${files.length} ä¸ªæ–‡ä»¶`);
                        } else {
                            throw new Error("è¿”å›çš„æ•°æ®ä¸æ˜¯æœ‰æ•ˆçš„æ•°ç»„æ ¼å¼");
                        }
                    })
                    .catch(error => {
                        console.error('è·å–æ–‡ä»¶åˆ—è¡¨å¤±è´¥:', error);
                        fileTreeContainer.innerHTML = `
                            <div class="error-message">
                                <p>âš ï¸ æ— æ³•åŠ è½½è¯¾ç¨‹ç›®å½•</p>
                                <p class="error-details">é”™è¯¯ä¿¡æ¯: ${error.message}</p>
                                <p class="error-env">ç¯å¢ƒ: ${isGitHubPages ? 'GitHub Pages' : 'æœ¬åœ°å¼€å‘'}</p>
                                <button onclick="location.reload()" class="retry-btn">é‡è¯•</button>
                            </div>
                        `;
                    })
                    .finally(() => {
                        hideLoading();
                    });
            }

            getFiles();

            // å°†æ‰å¹³è·¯å¾„åˆ—è¡¨è½¬æ¢ä¸ºå±‚çº§æ ‘ç»“æ„
            function buildTree(paths) {
                const tree = {};
                paths.forEach(path => {
                    const pathString = (typeof path === 'object' && path !== null) ? path.path : path;
                    if (typeof pathString !== 'string') return;

                    const parts = pathString.replace(/\\/g, '/').split('/');
                    let current = tree;
                    let currentPath = '';
                    parts.forEach((part, index) => {
                        currentPath += (currentPath ? '/' : '') + part;
                        if (!current[part]) {
                            current[part] = { __path: currentPath };
                        }
                        if (index === parts.length - 1) {
                            current[part].__isFile = true;
                        }
                        current = current[part];
                    });
                });
                return tree;
            }

            // é€’å½’æ¸²æŸ“æ–‡ä»¶æ ‘
            function renderTree(node, container) {
                const isRoot = container.id === 'file-tree';
                if (isRoot) {
                    container.innerHTML = '';
                }

                const ul = document.createElement('ul');

                // æŒ‰åç§°å‡åºæ’åº
                const sortedKeys = Object.keys(node)
                    .filter(key => !key.startsWith('__'))
                    .sort((a, b) => a.localeCompare(b, 'zh-CN', { sensitivity: 'base' }));

                for (const key of sortedKeys) {
                    const li = document.createElement('li');
                    const item = node[key];
                    const itemPath = item.__path;

                    if (item.__isFile) {
                        const a = document.createElement('a');
                        a.textContent = key.replace(/\.json$/, ''); // ç§»é™¤ .json åç¼€
                        a.href = '#';
                        a.classList.add('file');
                        a.dataset.path = itemPath;
                        a.addEventListener('click', (e) => {
                            e.preventDefault();
                            e.stopPropagation();
                            document.querySelectorAll('#file-tree .file.active').forEach(el => el.classList.remove('active'));
                            a.classList.add('active');
                            loadFileContent(itemPath);
                            addToRecentFiles(itemPath);
                        });
                        li.appendChild(a);
                    } else {
                        const folderContent = document.createElement('div');
                        folderContent.classList.add('folder-content');
                        folderContent.textContent = key;
                        li.appendChild(folderContent);
                        li.classList.add('folder');

                        // ä¸ºæ–‡ä»¶å¤¹å…ƒç´ æ·»åŠ è·¯å¾„æ•°æ®ï¼Œä¾¿äºé¢åŒ…å±‘å¯¼èˆªå®šä½
                        li.dataset.folderPath = itemPath;

                        // åªæœ‰åœ¨ expandedFolders ä¸­æ˜ç¡®åŒ…å«æ­¤è·¯å¾„æ—¶æ‰å±•å¼€
                        // é»˜è®¤çŠ¶æ€ç”± CSS ç¡®ä¿ä¸ºæŠ˜å çŠ¶æ€
                        if (expandedFolders && expandedFolders.has && expandedFolders.has(itemPath)) {
                            li.classList.add('expanded');
                        }

                        li.addEventListener('click', (e) => {
                            e.stopPropagation();
                            if (e.target === li || e.target === folderContent) {
                                const isExpanded = li.classList.toggle('expanded');
                                if (isExpanded) {
                                    expandedFolders.add(itemPath);
                                } else {
                                    expandedFolders.delete(itemPath);
                                }
                                saveExpandedState();
                            }
                        });
                        renderTree(item, li);
                    }
                    ul.appendChild(li);
                }
                container.appendChild(ul);
            }

            // 2. åŠ è½½å¹¶æ˜¾ç¤ºæ–‡ä»¶å†…å®¹
            function loadFileContent(path) {
                showLoading();
                updateBreadcrumb(path);

                // æ£€æµ‹è¿è¡Œç¯å¢ƒ
                const isGitHubPages = window.location.hostname.includes('github.io');
                const apiUrl = isGitHubPages ?
                    `/api/content?path=${encodeURIComponent(path)}` :
                    `/api/content?path=${encodeURIComponent(path)}`;

                fetch(apiUrl)
                    .then(response => response.json())
                    .then(data => {
                        if (data.content) {
                            contentContainer.innerHTML = `
                                <div class="content-wrapper">
                                    <div class="file-content">${data.content}</div>
                                </div>
                            `;
                        } else {
                            contentContainer.innerHTML = `
                                <div class="error-message">
                                    <h2>ğŸ“„ æ— æ³•åŠ è½½å†…å®¹</h2>
                                    <p>æ–‡ä»¶å¯èƒ½ä¸å­˜åœ¨æˆ–æ ¼å¼ä¸æ­£ç¡®</p>
                                </div>
                            `;
                        }
                    })
                    .catch(error => {
                        console.error('è·å–æ–‡ä»¶å†…å®¹å¤±è´¥:', error);
                        contentContainer.innerHTML = `
                            <div class="error-message">
                                <h2>âŒ åŠ è½½å†…å®¹æ—¶å‡ºé”™</h2>
                                <p class="error-details">${error.message}</p>
                                <button onclick="loadFileContent('${path}')" class="retry-btn">é‡è¯•</button>
                            </div>
                        `;
                    })
                    .finally(() => {
                        hideLoading();
                    });
            }

            // äº‹ä»¶ç›‘å¬å™¨è®¾ç½®
            function setupEventListeners() {
                // æœç´¢è¾“å…¥äº‹ä»¶
                searchInput.addEventListener('input', debounce(performSearch, 300));
                searchInput.addEventListener('keydown', handleSearchKeydown);

                // æ¸…é™¤æœç´¢æŒ‰é’®
                searchClear.addEventListener('click', clearSearch);

                // å…¨å±€å¿«æ·é”®
                document.addEventListener('keydown', handleGlobalKeydown);

                // ä¸»é¢˜åˆ‡æ¢
                document.getElementById('toggle-theme').addEventListener('click', toggleTheme);

                // å­—ä½“å¤§å°è°ƒèŠ‚
                document.getElementById('font-size-decrease').addEventListener('click', () => adjustFontSize(-1));
                document.getElementById('font-size-increase').addEventListener('click', () => adjustFontSize(1));
            }

            // é˜²æŠ–å‡½æ•°
            function debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            }

            // æœç´¢é”®ç›˜äº‹ä»¶å¤„ç†
            function handleSearchKeydown(e) {
                if (!isSearchMode) return;

                switch (e.key) {
                    case 'ArrowDown':
                        e.preventDefault();
                        selectedIndex = Math.min(selectedIndex + 1, filteredFiles.length - 1);
                        updateSearchSelection();
                        break;
                    case 'ArrowUp':
                        e.preventDefault();
                        selectedIndex = Math.max(selectedIndex - 1, 0);
                        updateSearchSelection();
                        break;
                    case 'Enter':
                        e.preventDefault();
                        if (selectedIndex >= 0 && filteredFiles[selectedIndex]) {
                            loadFileContent(filteredFiles[selectedIndex].path);
                            clearSearch();
                        }
                        break;
                    case 'Escape':
                        e.preventDefault();
                        clearSearch();
                        break;
                }
            }

            // å…¨å±€é”®ç›˜äº‹ä»¶å¤„ç†
            function handleGlobalKeydown(e) {
                if (e.ctrlKey && e.key === 'f') {
                    e.preventDefault();
                    searchInput.focus();
                    searchInput.select();
                }

                if (e.key === 'Escape' && isSearchMode) {
                    clearSearch();
                }
            }

            // æ›´æ–°æœç´¢é€‰æ‹©çŠ¶æ€
            function updateSearchSelection() {
                const items = searchResults.querySelectorAll('.search-result-item');
                items.forEach((item, index) => {
                    item.classList.toggle('selected', index === selectedIndex);
                });

                // æ»šåŠ¨åˆ°é€‰ä¸­é¡¹
                if (items[selectedIndex]) {
                    items[selectedIndex].scrollIntoView({ block: 'nearest' });
                }
            }

            // ä¸»é¢˜åˆ‡æ¢
            function toggleTheme() {
                const isDark = document.body.classList.toggle('dark-theme');

                // åŒæ—¶æ›´æ–° documentElementï¼Œç¡®ä¿é¢„åŠ è½½è„šæœ¬å’Œè¿è¡Œæ—¶è„šæœ¬ä¸€è‡´
                if (isDark) {
                    document.documentElement.classList.add('dark-theme');
                } else {
                    document.documentElement.classList.remove('dark-theme');
                }

                localStorage.setItem('theme', isDark ? 'dark' : 'light');

                const themeBtn = document.getElementById('toggle-theme');
                themeBtn.textContent = isDark ? 'â˜€ï¸' : 'ğŸŒ™';
            }

            // å­—ä½“å¤§å°è°ƒèŠ‚
            function adjustFontSize(delta) {
                const currentSize = parseInt(localStorage.getItem('fontSize')) || 16;
                const newSize = Math.max(12, Math.min(24, currentSize + delta));
                document.documentElement.style.fontSize = newSize + 'px';
                localStorage.setItem('fontSize', newSize);
            }

            // åˆå§‹åŒ–ä¸»é¢˜å’Œå­—ä½“å¤§å°
            function initializeSettings() {
                // ä¸»é¢˜å’Œå­—ä½“å¤§å°å·²åœ¨ head ä¸­é¢„åŠ è½½ï¼Œè¿™é‡Œåªéœ€è¦æ›´æ–°æŒ‰é’®çŠ¶æ€
                const savedTheme = localStorage.getItem('theme');
                if (savedTheme === 'dark') {
                    // ç¡®ä¿ä¸»é¢˜ç±»åº”ç”¨åˆ° body è€Œä¸æ˜¯ documentElement
                    document.body.classList.add('dark-theme');
                    document.getElementById('toggle-theme').textContent = 'â˜€ï¸';
                } else {
                    // å¦‚æœä¸æ˜¯æ·±è‰²ä¸»é¢˜ï¼Œç¡®ä¿ç§»é™¤å¯èƒ½å­˜åœ¨çš„ç±»
                    document.documentElement.classList.remove('dark-theme');
                }

                // å­—ä½“å¤§å°å·²åœ¨ head ä¸­è®¾ç½®ï¼Œè¿™é‡Œä¸éœ€è¦é‡å¤è®¾ç½®
            }

            // æ·»åŠ é‡ç½®æ–‡ä»¶æ ‘çŠ¶æ€çš„åŠŸèƒ½ï¼ˆç”¨äºè°ƒè¯•æˆ–é‡ç½®ï¼‰
            function resetFileTreeState() {
                expandedFolders.clear();
                saveExpandedState();

                // ç«‹å³æ›´æ–°å½“å‰é¡µé¢çš„æ˜¾ç¤ºçŠ¶æ€
                document.querySelectorAll('#file-tree .folder.expanded').forEach(folder => {
                    folder.classList.remove('expanded');
                });

                console.log('æ–‡ä»¶æ ‘çŠ¶æ€å·²é‡ç½®ï¼Œæ‰€æœ‰æ–‡ä»¶å¤¹å·²æŠ˜å ');
            }

            // åœ¨æ§åˆ¶å°æš´éœ²é‡ç½®åŠŸèƒ½ï¼Œæ–¹ä¾¿è°ƒè¯•
            window.resetFileTreeState = resetFileTreeState;

            // åˆå§‹åŒ–åº”ç”¨
            initializeSettings();
            setupEventListeners();
            getFiles();

            // é¡µé¢å®Œå…¨åŠ è½½åç§»é™¤åŠ è½½çŠ¶æ€
            setTimeout(() => {
                document.documentElement.classList.remove('page-loading');
            }, 100);
        });
    </script>
</body>
</html>